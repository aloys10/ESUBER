# 4. 实验

为了评估改进后的SUBER系统的有效性，我们设计了一系列实验来验证各个组件的性能和整体框架的有效性。我们的实验主要围绕四个核心模块的改进展开：用户画像生成模块通过引入分层抽样算法和情感特征字典，实现了600个具有统计学代表性的合成用户生成，每个用户包含活动水平、从众程度、多样性偏好三个情感维度；物品检索模块设计了基于内容相似性、时间衰减和情感一致性的多维度检索机制，通过指数衰减公式（λ=0.15）和情感一致性奖励（基础值0.2）优化检索质量；情感记忆模块实现了基于效价-唤醒度二维模型的情感标签自动推断，建立了情感一致性计算和记忆更新机制；强化学习推荐系统提供了多种环境包装器和算法支持，包括DQN、PPO、A2C、TRPO四种算法的完整实现。

## 4.1 实验设置

### 4.1.1 数据集配置与用户生成

我们构建了两个推荐环境来验证改进后的SUBER系统的泛化能力。电影推荐环境基于MovieLens (ml-latest-small)数据集构建，该数据集可从https://grouplens.org/datasets/movielens/下载获取，包含约100,000条评分记录和9,000部电影的元数据。我们对原始数据进行了预处理，提取电影的基本信息（标题、年份、时长）、类型标签（动作、喜剧、科幻等20个类别）、演员导演信息（前5名演员和导演），并通过TMDB API补充了电影描述和海报信息。为了适应我们的评分推理任务，将原始的0.5-5.0评分尺度映射为1-9的整数评分体系，确保LLM能够稳定地生成离散评分值。

图书推荐环境则基于Amazon图书数据集的子集构建，原始数据集可从http://jmcauley.ucsd.edu/data/amazon/下载。我们选择了Books类别的元数据，包含图书的标题、作者、类别、描述、平均评分等信息，并对数据进行清洗和筛选，保留评论数量大于10的图书以确保质量。图书类别系统包含文学、科技、历史、艺术、商业等15个主要类别，采用1-5的评分体系与Amazon评论数据集保持一致。

用户生成系统采用分层抽样算法生成600个具有统计学代表性的合成用户。用户属性分布严格遵循真实人口统计学数据：年龄分布基于美国人口普查数据，包含7个年龄段（4-12岁15%，13-17岁20%，18-24岁25%，25-34岁20%，35-44岁12%，45-54岁5%，55岁以上3%）；性别分布为男性52%，女性48%；职业类型从包含50+种职业的预定义列表中采样，涵盖工程师、教师、医生、艺术家、学生等，年龄小于18岁的用户统一分配为学生。

每个用户包含完整的属性字段，涵盖基础信息、职业爱好和情感特征三个层次。基础信息字段包括用户ID（唯一标识符）、姓名（通过Vicuna生成的真实感姓名）、年龄（4-75岁，按7个年龄段分布）、性别（M/F，男性52%，女性48%）、描述文本（个性化描述，包含性格特征和偏好倾向）。职业爱好字段包括职业类型（从50+种预定义职业中采样，如工程师、教师、医生、艺术家、学生等，18岁以下统一为学生）、兴趣爱好（从30+种爱好中采样，如运动、阅读、音乐、旅行、烹饪等）、儿童友好爱好（针对年轻用户的15+种适合爱好，如绘画、游戏、户外活动等）。

三个核心情感特征维度采用三级分类体系：活动水平反映用户对推荐系统的使用频率和接受程度，分为低活动水平（30%，极少观看，几乎不被推荐吸引）、中等活动水平（50%，偶尔观看，只对严格符合口味的物品感兴趣）、高活动水平（20%，电影爱好者，愿意观看几乎所有推荐）；从众程度反映用户评分时对历史评分的依赖程度，分为低从众程度（25%，忠实追随者，严重依赖历史评分）、中等从众程度（50%，平衡评估者，同时考虑历史评分和个人偏好）、高从众程度（25%，特立独行的评论家，完全基于个人品味）；多样性偏好反映用户对不同类型内容的接受程度，分为低多样性偏好（25%，极其挑剔的选择性观看者，不允许任何多样性暗示）、中等多样性偏好（50%，小众探索者，偶尔探索不同类型）、高多样性偏好（25%，电影开拓者，追求独特和晦涩作品）。

用户生成过程采用分层抽样算法确保统计学代表性，使用Vicuna模型结合Guidance框架，通过结构化的三部分提示词模板（基础属性、职业爱好、情感特征）确保生成用户的一致性和可控性。生成过程首先按预设比例分配各年龄组用户数量，然后平衡性别分布，接着分层生成情感特征，最后根据年龄选择合适的职业爱好并生成个性化描述文本。所有用户数据保存为CSV格式（user_features_600.csv），包含所有字段的完整信息，便于实验调用和统计分析。

### 4.1.2 技术配置

LLM配置方面，系统支持多种模型，包括DeepSeek系列（deepseek-chat、deepseek-reason等）、Llama-2-7b-Chat-GPTQ、Mistral等，通过统一的LLM接口进行调用。DeepSeek模型通过OpenAI兼容的API接口实现，支持环境变量DEEPSEEK_API_KEY或OPENAI_API_KEY进行认证，默认使用https://api.deepseek.com作为基础URL。模型调用参数设置为temperature=0.2、top_p=0.9、max_tokens=5（评分任务）或120（解释任务），确保输出的一致性和可控性。

提示策略系统提供了18种不同的LLM评分器选项，包括0-shot、1-shot、2-shot三种学习模式，每种模式都支持自定义系统提示（our）和默认系统提示（default）两种版本。系统还支持1-9、1-10、one-ten三种评分尺度，以及增强版Chain of Thought推理（cot_enhanced）。默认配置使用0Shot_cotlite_our，即0-shot学习结合CoT-lite推理和自定义系统提示。电影特征列表包含title、overview、genres、actors、vote_average五个核心字段，历史交互特征包含title和rating两个字段。

检索组件实现了五种不同的检索策略，每种策略都有具体的实现类。decay_emotion_3（默认）使用DecayEmotionWeightedRetrieval类，结合内容相似性、时间衰减和情感一致性，计算公式为score = similarity(curr, hist) × exp(-λ × age) × (1 + emotion_bonus)，其中λ=0.15，emotion_bonus=0.2。most_similar_3使用SentenceSimilarityItemsRetrieval类，基于overview_embedding字段的余弦相似度计算。last_3使用TimeItemsRetrieval类，按时间戳降序返回最近的交互记录。simple_3使用SimpleMoviesRetrieval类，基于演员、类型、评分、导演的Sørensen系数计算相似性。none使用TimeItemsRetrieval(0)表示不使用历史检索。

奖励扰动系统提供三种选择：NoPerturbator（无扰动）、GaussianPerturbator（高斯噪声）、GreedyPerturbator（贪婪扰动，以概率q进行±1调整）。奖励整形系统提供五种选择：IdentityRewardShaping（恒等映射）、RewardReshapingExpDecayTime（指数时间衰减）、RewardReshapingRandomWatch（随机观看）、RewardReshapingTerminateIfSeen（重复观看终止）、RewardReshapingChurnSatisfaction（满意度流失终止）。情感记忆系统支持效价和唤醒度的自动推断，默认阈值设置为效价正面≥7.0、负面≤4.0，唤醒度高≥8.0、低≤3.0。

强化学习配置支持DQN、PPO、A2C、TRPO四种算法，通过Stable-Baselines3库实现。训练参数包括学习率3e-4、批次大小64、折扣因子0.99，训练轮数1000个episode，每个episode最多50步交互。环境包装器提供StableBaselineWrapper（one-hot编码）和StableBaselineWrapperNum（数值编码）两种选择，物品选择器使用GreedySelector实现贪心选择策略。

## 4.2 消融实验

模型与评分器方面，我们选择了种不同的LLM评分器选项，包括2Shot_system_our、1Shot_system_our、0Shot_system_our、0Shot_cotlite_our（默认）、2Shot_system_default、1Shot_system_default、0Shot_system_default以及三种增强版本2Shot_cot_enhanced、1Shot_cot_enhanced、0Shot_cot_enhanced，其中cotlite表示Chain of Thought轻量版推理，所有实验均使用deepseek-chat作为基础模型。

检索策略配置选择：decay_emotion_3基于内容相似性×时间衰减×情感一致性的多维度检索，奖励扰动器提供三种选择：none（默认）不对评分进行扰动，greedy以概率q将LLM生成的评分进行±1调整，gaussian向LLM评分添加高斯噪声。

用户数据集配置包含三种不同的用户群体：detailed（默认）加载user_features_600包含完整的用户画像和情感特征，basic加载user_features_hard_600为简化版用户特征，sampled_genres加载user_features_sampled_genres_600为基于类型采样的用户。环境组件统一使用GreedySelector作为物品选择器实现贪心选择策略，IdentityRewardShaping作为奖励整形器进行恒等映射不做额外塑形，随机种子固定为42确保所有实验结果可重现。实际运行的研究集合中，当前启用MoviesCollectionStudy验证系统对电影系列的识别和评分一致性，SamplingSubsetInteractionsStudy分析不同采样策略对评分分布的影响可通过--skip-sampling跳过，而CategoryPreferenceStudy、HighRatingStudy、LowRatingStudy当前在代码中注释禁用但可按需启用。为了验证SUBER框架改进后各个组件的有效性，我们设计了四个核心测试案例：

### 4.2.1 类型/类别识别能力测试（CategoryPreferenceStudy）

**测试目标**：验证环境是否能够准确识别电影/图书类型，并将其与用户偏好正确关联

**具体实现**：该测试为8个主要电影类型（动作、动画、喜剧、纪录片、家庭、奇幻、恐怖、浪漫）分别创建了4个专门的用户档案，每个用户都明确表达对特定类型的强烈偏好。

**用户档案设计**：以动作片用户为例，系统创建了4个用户（Emily Riga、Ethan Mitchell、Oliva Turner、Marcus Roger），每个用户都包含详细的个人描述，明确表达"对动作片给予8-10分高评分，对其他类型给予1-5分低评分"的评分策略。用户描述包含年龄、性别、性格特征和评分逻辑，确保LLM能够理解并执行一致的评分行为。

**测试流程**：
1. **正面测试**：使用包含该类型电影的数据集进行测试
2. **负面测试**：使用包含非该类型电影的数据集进行测试
3. **评分验证**：让每个用户对所有电影进行评分
4. **性能计算**：计算正面测试中评分≥8的比例和负面测试中评分≤5的比例

**评估指标**：计算正面测试和负面测试的成功率，最终得分为两者的平均值。

### 4.2.2 高/低评分推断能力测试（HighRatingStudy & LowRatingStudy）

**测试目标**：验证环境是否能够根据用户描述准确推断评分倾向

**高评分测试实现**：创建了4个"总是给高分"的用户档案，包括：
- William Anderson（25岁男性）：电影爱好者，对所有电影都给予10分
- Sophia Evans（12岁女性）：年轻女孩，每次看电影都给予10分
- Benjamin Murphy（95岁男性）：有记忆问题的老人，总是给予10分
- Ava Wilson（80岁女性）：将电影作为唯一娱乐来源，总是给予10分

**测试流程**：
1. 使用包含各种类型电影的数据集进行测试
2. 让每个用户对所有电影进行评分
3. 计算评分≥9的比例作为成功率

**低评分测试实现**：创建了4个"总是给低分"的用户档案，测试逻辑与高评分测试相反，计算评分≤3的比例作为成功率。

### 4.2.3 物品集合关联能力测试（MoviesCollectionStudy）

**测试目标**：验证环境是否能够利用用户的历史物品评分来预测未来评分

**具体实现**：该测试通过构建用户历史交互记录来验证系统的预测能力。

**测试设计**：
1. **系列数据准备**：使用包含多个电影系列的数据集
2. **用户历史构建**：从600个合成用户中随机选择100个用户进行测试
3. **历史交互模拟**：为每个用户构建历史交互记录

**测试流程**：
1. **正面测试**：为系列中的前几部电影分配高评分（10分），为随机电影分配平均评分（6.53分）
2. **负面测试**：为系列中的前几部电影分配低评分（1分），为随机电影分配平均评分
3. **预测验证**：测试环境是否能够为系列的最后一部电影生成相应的评分
4. **性能计算**：计算正面测试中评分≥7的比例和负面测试中评分≤5的比例

**关键逻辑**：系统通过构建用户的历史交互记录，为系列电影分配相应的评分，然后测试环境是否能够基于这些历史信息为新的系列电影生成一致的评分。

### 4.2.4 真实评分分布相似性测试（SamplingSubsetInteractionsStudy）

**测试目标**：验证环境生成的评分分布是否准确反映人类行为

**具体实现**：该测试通过对比环境生成的评分分布与真实数据集（MovieLens/Amazon）的评分分布来验证系统的真实性。

**测试方法**：
1. **有放回采样**：从环境和真实数据集中进行有放回采样
2. **经验分布计算**：计算两个数据集上的经验分布
3. **相似性度量**：使用总变差距离（Total Variation Distance）作为相似性度量
4. **一致性评估**：评估环境评分分布与人类评分分布的一致性

**评估指标**：通过统计检验和分布对比，验证环境生成的评分分布是否与真实用户行为模式一致，确保SUBER系统能够准确模拟人类用户的评分行为。

## 4.3 消融实验结果分析

基于图书推荐环境的消融实验结果，我们对不同配置下的系统性能进行了详细分析。实验使用DeepSeek-chat模型，对比了三种不同的提示策略：0-shot CoT-lite、1-shot system our和2-shot system our。

### 4.3.1 类型/类别识别能力测试结果

**整体性能表现**：三种提示策略在图书类别识别任务上均表现出色，平均成功率分别为0.87、0.96和0.97。结果显示，随着示例数量的增加，系统性能呈现上升趋势。

**具体类别分析**：
- **最佳表现类别**：Humor（幽默类）在所有配置下均达到100%成功率，Philosophy（哲学类）和Computer（计算机类）在1-shot和2-shot配置下也达到完美表现
- **挑战性类别**：Fiction（小说类）表现相对较弱，0-shot配置下成功率为76.25%，1-shot和2-shot配置下分别提升至80.63%和82.50%
- **一致性表现**：Economics（经济学类）在0-shot配置下表现较差（73.13%），但在1-shot和2-shot配置下显著提升至98.13%和98.75%

**正面vs负面测试对比**：所有配置在负面测试（识别不喜欢类别）上的表现均优于正面测试（识别喜欢类别），负面测试平均成功率为99.2%，而正面测试平均成功率为78.5%，表明系统在识别用户不偏好方面更加准确。

### 4.3.2 高/低评分推断能力测试结果

**高评分测试**：0-shot CoT-lite配置表现最佳，成功率达到84.53%，而1-shot和2-shot配置的成功率分别为50.47%和52.34%。这一结果表明，CoT-lite推理策略在理解"总是给高分"的用户行为模式方面具有显著优势。

**低评分测试**：所有三种配置在低评分测试中均达到100%成功率，表明系统在识别"总是给低分"的用户行为模式方面表现完美，能够准确理解并执行消极评分策略。

**评分倾向理解能力**：系统在理解消极评分倾向方面明显优于积极评分倾向，这可能与LLM在训练过程中接触到的负面评价模式有关。

### 4.3.3 物品集合关联能力测试结果

**整体性能**：三种配置在图书集合关联测试中的平均成功率分别为81.45%、74.93%和76.13%。0-shot CoT-lite配置表现最佳，表明CoT推理在理解用户历史偏好模式方面具有优势。

**正面vs负面关联**：
- **正面关联**：0-shot CoT-lite配置成功率为70.20%，1-shot和2-shot配置分别为53.10%和54.80%
- **负面关联**：所有配置在负面关联测试中均表现优异，成功率分别为92.70%、96.75%和97.45%

**历史偏好学习能力**：系统能够有效利用用户的历史评分记录来预测未来评分，特别是在识别用户不喜欢的图书类型方面表现突出。

### 4.3.4 综合性能分析

**最佳配置识别**：0-shot CoT-lite配置在多个测试中表现最佳，特别是在高评分推断和物品集合关联任务中，表明Chain of Thought轻量版推理策略能够更好地理解复杂的用户行为模式。

**提示策略效果**：虽然1-shot和2-shot配置在类别识别任务中表现更好，但在理解用户评分倾向和历史偏好方面，0-shot CoT-lite配置具有明显优势，说明推理策略比示例学习更有效。

**系统鲁棒性**：所有配置在负面测试中均表现优异，表明SUBER系统在识别用户不偏好方面具有很强的鲁棒性，这对于推荐系统的冷启动和多样性推荐具有重要意义。

**实际应用价值**：实验结果验证了SUBER系统能够准确模拟人类用户的评分行为，特别是在理解用户偏好边界和利用历史交互信息方面，为构建更智能的推荐系统提供了有力支持。







