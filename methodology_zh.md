## 方法 Methodology（中文）

### 问题表述
本文研究一种融合情绪感知记忆与检索机制的基于大语言模型（LLM）的交互式推荐环境。在每一步交互中，系统从用户历史中检索少量交互样本，将其组织为受约束的提示词，并调用 LLM 生成标量评分与简短解释。随后系统把该评分写回记忆，实现闭环适应。

### 研究动机与设计原则
- 近期性与相关性并重：仅依赖内容相似性可能选中“久远但相似”的历史，难以反映偏好的时变特性；仅依赖时间窗口又可能纳入“近期但不相似”的样本。我们提出将相似度与时间衰减联合建模。
- 情绪作为行为中介：用户评分常受情绪状态显著影响，而情绪状态具有短时连续性。我们引入情绪一致性加成，期望更好地解释并利用短期偏好漂移。
- 可解释性与可评测性：通过 CoT‑lite 约束输出结构，既提升输出可解析性，也让检索信号与解释语义对齐，便于对齐误差的诊断与分析。

### 情绪感知记忆表示
我们为每个用户维护时间有序的交互记忆：

⟨item_id, rating, timestamp, num_watches, valence, arousal⟩。

情绪标签由评分阈值自动推断，以避免人工标注并提升可复现性。为避免魔法数字，阈值以命名常量集中配置：
- Valence（正负性）阈值 V_pos 与 V_neg，将评分映射到 {positive, neutral, negative}；
- Arousal（唤醒度）阈值 A_high 与 A_low，将评分映射到 {high, medium, low}。

若未另行说明，默认取 V_pos=7.0、V_neg=4.0、A_high=8.0、A_low=3.0。实现中集中管理这些阈值，便于审查与消融。

#### 理论依据与讨论
- 从认知连续性与情绪迁移角度，近邻时间的情绪标签更能代表“当下”偏好；我们通过对“最近一次交互”的情绪进行一致性度量，作为加成信号，近似建模这一心理学观察。
- 从贝叶斯角度，情绪一致性可被视作对历史样本权重的修正先验；其对相似度与时间衰减的乘性调制，等价于对对数域打分的线性平移，便于解释其与其他因素的可分贡献。

### 情绪感知检索
针对当前候选条目 curr 与历史交互 hist，我们定义多因素相关性评分，并选取前 K 条（默认 K=3）：

score = sim(curr, hist) × exp(−λ · age) × (1 + 1[emotion_match] · bonus)。

- sim：基于条目嵌入的余弦相似度（图书使用 description_embedding）。
- age：与最近一次交互的逻辑时间差，λ 为时间衰减系数（默认 0.15）。
- 1[emotion_match]：与最近一次交互在情绪维度的一致性指示（默认基于 valence，可选含 arousal）。
- bonus：情绪一致性加成（默认 0.2）。

#### 复杂度与实现细节
- 检索阶段对历史集合做线性打分，并取 Top‑K；当用户历史长度为 H、候选为单条时，时间复杂度为 O(H)（向量相似度可预计算或采用近似检索进一步优化）。
- 我们以命名参数暴露 K、λ、bonus 及 arousal 开关；情绪阈值集中于 Memory 模块，便于统一调整。

### 受约束的 CoT‑lite 提示
- 模板引导 LLM 输出“1–3 条与检索信号对齐的极简理由 + 单独一行数值评分”。
- 好处：（i）结构与语义稳定，降低解析失败概率；（ii）解释与检索信号一一对应，便于误差归因；（iii）控制冗长，有利于跨批次与跨模型对齐。
- 我们保留零样本、少样本模板变体用于消融（0/1/2‑Shot）。

### 评分与奖励整形
- 默认不注入噪声，奖励整形为恒等映射，最终分数等于 LLM 预测评分，隔离检索与提示对结果的纯粹贡献。
- 在特定对照中，我们启用带噪声扰动器与非恒等整形，以评估鲁棒性与现实性。

### 会话终止机制
- 随机终止：每步以小概率 p 结束会话，用以模拟不可预期流失。
- 满意度驱动终止（通过奖励整形）：综合低分阈值、连续低分立即终止（连续 L 次）、EMA 门控（阈值以下按概率终止）、连续高分恢复与最小步数保护（前 S 步不终止）。
- 我们报告恒等整形（无终止）与满意度整形两种设置，以衡量现实性与可比性之间的权衡。

### 鲁棒性、局限与威胁到效度
- 鲁棒性：我们在不同 LLM、不同 Shot 数、不同检索超参、是否考虑 arousal 等维度进行系统性消融，观察一致性与方差。
- 局限：情绪由评分阈值间接推断，难以刻画复杂情绪；乘性整合假设或不适用于某些行为结构；Top‑K 策略未显式建模多样性。
- 内部效度威胁：模板诱导与模型偏置可能导致评分分布收敛；我们通过多模型、多模板与不同随机种子进行对照缓解。
- 外部效度威胁：在真实在线场景中，用户情绪与语境更复杂；我们将情绪阈值与检索系数开放为可学习或可自适应参数，作为未来工作。
